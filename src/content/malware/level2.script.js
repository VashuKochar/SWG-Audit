// Load shared result helper
(function() {
  var script = document.createElement('script');
  script.src = '/js/shared/result-helper.js';
  script.onload = function() {
    initChunkedDownload();
  };
  document.head.appendChild(script);
})();

function initChunkedDownload() {
  var btn = document.getElementById('chunked-download');

  if (!btn) return;

  btn.addEventListener('click', function () {
    hideResults(); // Clear any previous results
    
    function getChunk(num) {
      return fetch('/malware/chunk/' + num).then(function (r) {
        if (!r.ok) return Promise.reject({ blocked: true, status: r.status });
        return r.text();
      });
    }
    
    Promise.all([getChunk(1), getChunk(2)])
      .then(function (parts) {
        // Both chunks fetched successfully - assemble and download
        var full = parts[0] + parts[1];
        var blob = new Blob([full], { type: 'text/plain' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'EICAR_assembled.txt';
        a.click();
        URL.revokeObjectURL(url);
        
        // Download completed = perimeter FAILED
        showResult('fail');
      })
      .catch(function (err) {
        // Request blocked or failed = perimeter PASSED
        showResult('pass');
      });
  });
}
