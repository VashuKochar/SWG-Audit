(function () {
  var btn = document.getElementById('chunked-download');
  var result = document.getElementById('chunked-result');

  if (!btn) return;

  btn.addEventListener('click', function () {
    function getChunk(num) {
      return fetch('/malware/chunk/' + num).then(function (r) {
        if (!r.ok) return Promise.reject({ blocked: true, status: r.status });
        return r.text();
      });
    }
    Promise.all([getChunk(1), getChunk(2)]).then(function (parts) {
      var full = parts[0] + parts[1];
      var blob = new Blob([full], { type: 'text/plain' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'EICAR_assembled.txt';
      a.click();
      URL.revokeObjectURL(url);
      result.textContent = 'Download completed: perimeter may have failed to block fragmented delivery. Check whether the SWG inspects reassembled content or only single responses.';
      result.className = 'error';
      result.hidden = false;
    }).catch(function (err) {
      if (err && err.blocked) {
        result.textContent = 'Request blocked (HTTP ' + (err.status || '') + '). Perimeter may have passed.';
        result.className = 'success';
      } else {
        result.textContent = 'Request failed (network error or blocked). If the connection was dropped, the perimeter may have blocked the request; otherwise check your network and retry.';
        result.className = 'success';
      }
      result.hidden = false;
    });
  });
})();
